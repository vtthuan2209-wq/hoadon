<!DOCTYPE html>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .then(() => console.log("SW registered"))
    .catch(err => console.log(err));
}
</script>
<html lang="vi">
<head>
	<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2a8bdc">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta charset="UTF-8">
  <title>WebApp H√≥a ƒê∆°n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family:"Times New Roman",serif; background:#f0f0f0; margin:0; padding:10px; }
    #invoice { background:#fff; padding:12px; max-width:100%; margin:auto; border:1px solid #ccc; font-size:14px; font-family:"Times New Roman",serif; }
    h1 { text-align:center; margin:8px 0; font-size:22px; }
    table { 
  width:100%; 
  border-collapse:collapse; 
  margin-top:6px; 
  font-size:12px; 
  table-layout:fixed; 
}
th, td { 
  border:1px solid #000; 
  padding:2px 0px;   /* gi·∫£m padding ƒë·ªÉ h√†ng th·∫•p h∆°n */
  text-align:center; 
  line-height:1.2;   /* gi·∫£m chi·ªÅu cao d√≤ng */
}
td input { 
  width:100%; 
  border:none; 
  text-align:right; 
  font-size:12px;    /* gi·∫£m font ƒë·ªÉ √¥ nh·ªè l·∫°i */
  padding:2px;       /* gi·∫£m padding trong √¥ nh·∫≠p */
  box-sizing:border-box; 
  height:16px;       /* chi·ªÅu cao c·ªë ƒë·ªãnh nh·ªè g·ªçn */
}
    .info { margin-bottom:2px; font-size:13px; display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
    .info label { font-weight:bold; margin-right:4px; }
    .info input { flex:1; min-width:100px; border:1px solid #ccc; padding:2px 4px; font-size:12px; }
    .controls { margin-top:12px; display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
    .btn { flex:1; min-width:120px; padding:10px; border:none; border-radius:20px;
           background:#2a8bdc; color:#fff; font-size:14px; font-weight:bold; cursor:pointer; text-align:center; }
    .btn-danger{ background:#e74c3c; }
    .footer{ margin-top:10px; font-size:12px; display:flex; justify-content:space-between; }
    .footer .date { text-align:left; }
    .footer .writer { text-align:center; margin-right:30px; }
    #previewImage { margin-top:10px; max-width:100%; display:none; border:1px solid #ccc; }
    #downloadLink { display:none; text-align:center; margin-top:8px; font-size:14px; color:blue; }

    /* T√πy ch·ªânh ƒë·ªô r·ªông c·ªôt */
    #productTable th:nth-child(2), #productTable td:nth-child(2) { width:55%; }
    #productTable th:nth-child(3), #productTable td:nth-child(3) { width:12%; }
    #productTable th:nth-child(4), #productTable td:nth-child(4) { width:25%; }

    /* ·∫®n vi·ªÅn cho input gi·ªëng ch·ªØ */
    .textlike {
      border:none; 
      outline:none; 
      background:transparent; 
      font-size:12px; 
      font-family:"Times New Roman",serif;
    }
#hotline {
  padding:1px 2px;   /* gi·∫£m kho·∫£ng c√°ch trong √¥ */
  height:16px;       /* chi·ªÅu cao th·∫•p h∆°n */
  line-height:16px;  /* cƒÉn ch·ªØ gi·ªØa */
  font-size:12px;
  box-sizing:border-box; 
}
    @media(max-width:480px){
      #invoice{padding:8px;font-size:12px;}
      h1{font-size:18px;}
      table{font-size:12px;}
      td input{font-size:12px;}
      .controls{flex-direction:column;}
      .btn{min-width:100%;font-size:13px;padding:6px;}
    }
  </style>
</head>
<body>
  <div id="invoice">
    <!-- Header -->
    <div style="display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:10px;">
      <div style="flex:0 0 80px;">
        <img src="data:image/png;base64,..." alt="Logo" style="max-width:80px;">
      </div>
      <div style="text-align:right; flex:1; font-size:13px;">
        <div style="font-weight:bold; font-size:16px;">C√îNG TY TNHH G·ªñ M·ªòT T·∫§M</div>
        <div>Hotline: 
          <input type="text" id="hotline" value="0568.638.638" 
                 class="textlike" style="text-align:right; width:70px;">
        </div>
        <div>X∆∞·ªüng: 138/3 APƒê03, P. An Ph√∫ ƒê√¥ng, Tp.HCM</div>
        <div>CH: 19 Hi·ªáp Th√†nh 43, P. T√¢n Th·ªõi Hi·ªáp, Tp.HCM</div>
      </div>
    </div>

    <h1>H√ìA ƒê∆†N</h1>

    <div class="info">
      <label>Kh√°ch h√†ng:</label> <input type="text" id="customer" placeholder="T√™n KH">
    </div>
    <div class="info">
      <label>SƒêT:</label> <input type="text" id="phone" placeholder="S·ªë ƒëi·ªán tho·∫°i">
    </div>
    <div class="info">
      <label>ƒêC:</label> <input type="text" id="address" placeholder="ƒê·ªãa ch·ªâ" style="flex:1">
    </div>

    <div style="overflow-x:auto;">
      <table id="productTable">
        <thead>
          <tr>
            <th>STT</th>
            <th>T√™n S·∫£n Ph·∫©m</th>
            <th>SL</th>
            <th>Th√†nh ti·ªÅn</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <table style="margin-top:0px;">
      <tr>
        <td colspan="3" style="text-align:right">V·∫≠n chuy·ªÉn:</td>
        <td><input type="text" id="shipping" value="0"></td>
      </tr>
      <tr>
        <td colspan="3" style="text-align:right">T·ªîNG ƒê∆†N:</td>
        <td><input type="text" id="totalOrder" value="0" readonly></td>
      </tr>
      <tr>
        <td colspan="3" style="text-align:right">C·ªåC TR∆Ø·ªöC:</td>
        <td><input type="text" id="deposit" value="0"></td>
      </tr>
      <tr>
        <td colspan="3" style="text-align:right">GIAO H√ÄNG THANH TO√ÅN:</td>
        <td><input type="text" id="finalPay" value="0" readonly></td>
      </tr>
    </table>

    <div class="footer">
      <div class="date">
        <input type="text" id="dateField" class="textlike" style="text-align:left; width:200px;">
      </div>
      <div class="writer">
        <div>Ng∆∞·ªùi vi·∫øt h√≥a ƒë∆°n</div>
        <div><input type="text" id="writerName" value="Thi√™n" class="textlike" style="text-align:center; width:100px; margin-top:4px;"></div>
      </div>
    </div>

    <div style="margin-top:6px; font-size:12px;">
      <p><b>T√™n: ƒêinh Duy Lu√¢n</b><br>STK: 974666<br>Ng√¢n h√†ng √Å Ch√¢u (ACB)</p>
    </div>
  </div>

  <!-- N√∫t th√™m / x√≥a s·∫£n ph·∫©m -->
  <div class="controls">
    <button id="addProduct" class="btn">‚ûï Th√™m s·∫£n ph·∫©m</button>
    <button id="removeProduct" class="btn btn-danger">‚ùå X√≥a s·∫£n ph·∫©m</button>
  </div>

  <!-- C√°c n√∫t l∆∞u, xu·∫•t -->
  <div class="controls">
    <button class="btn" onclick="saveInvoice()">üíæ L∆∞u t·∫°m</button>
    <button class="btn" onclick="exportImage()">üñº Xu·∫•t ·∫£nh</button>
    <button class="btn btn-danger" onclick="clearInvoice()">üóë X√≥a</button>
  </div>

  <img id="previewImage" alt="Preview h√≥a ƒë∆°n">
  <a id="downloadLink">‚¨áÔ∏è T·∫£i ·∫£nh v·ªÅ m√°y</a>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    function formatNumber(value){
      if(!value) return "0";
      return Number(value.toString().replace(/\D/g,"")||0).toLocaleString("vi-VN");
    }
    function parseNumber(value){
      return parseInt(value.toString().replace(/\D/g,"")||0);
    }

    function addRow(product="", qty=0, price=0){
      let tbody = document.querySelector("#productTable tbody");
      let rowCount = tbody.rows.length + 1;
      let row = document.createElement("tr");
      row.innerHTML = `
        <td>${rowCount}</td>
        <td><input type="text" value="${product}" placeholder="T√™n SP"></td>
        <td><input type="number" min="0" maxlength="3" class="qty" value="${qty}" style="text-align:center"></td>
        <td><input type="text" class="price" value="${formatNumber(price)}"></td>
      `;
      tbody.appendChild(row);
      row.querySelector(".qty").addEventListener("input", calculateTotal);
      row.querySelector(".price").addEventListener("input", calculateTotal);
      calculateTotal();
    }

    function removeRow(){
      let tbody = document.querySelector("#productTable tbody");
      if(tbody.rows.length > 0){
        tbody.deleteRow(-1);
        renumberRows();
        calculateTotal();
      }
    }

    function renumberRows(){
      document.querySelectorAll("#productTable tbody tr").forEach((row,i)=>{
        row.cells[0].textContent = i+1;
      });
    }

    function calculateTotal(){
      let rows = document.querySelectorAll("#productTable tbody tr");
      let subtotal = 0;
      rows.forEach(row=>{
        let qty = parseNumber(row.querySelector(".qty").value)||0;
        let price = parseNumber(row.querySelector(".price").value)||0;
        subtotal += qty * price;
        row.querySelector(".price").value = formatNumber(price);
      });
      let shipping = parseNumber(document.getElementById("shipping").value)||0;
      let deposit = parseNumber(document.getElementById("deposit").value)||0;
      let totalOrder = subtotal + shipping;
      let finalPay = totalOrder - deposit;
      document.getElementById("shipping").value = formatNumber(shipping);
      document.getElementById("deposit").value = formatNumber(deposit);
      document.getElementById("totalOrder").value = formatNumber(totalOrder);
      document.getElementById("finalPay").value = formatNumber(finalPay);
    }

    function saveInvoice(){
      let data = {
        hotline: document.getElementById("hotline").value,
        customer: document.getElementById("customer").value,
        phone: document.getElementById("phone").value,
        address: document.getElementById("address").value,
        shipping: document.getElementById("shipping").value,
        deposit: document.getElementById("deposit").value,
        date: document.getElementById("dateField").value,
        writer: document.getElementById("writerName").value,
        products: []
      };
      document.querySelectorAll("#productTable tbody tr").forEach(row=>{
        data.products.push({
          product: row.cells[1].querySelector("input").value,
          qty: row.cells[2].querySelector("input").value,
          price: row.cells[3].querySelector("input").value
        });
      });
      localStorage.setItem("invoiceData", JSON.stringify(data));
      alert("ƒê√£ l∆∞u d·ªØ li·ªáu!");
    }

    function clearInvoice(){
      localStorage.removeItem("invoiceData");
      alert("ƒê√£ xo√° d·ªØ li·ªáu!");
      location.reload();
    }

    function exportImage(){
      html2canvas(document.querySelector("#invoice"), {scale:2}).then(canvas => {
        let imgData = canvas.toDataURL("image/png");
        let img = document.getElementById("previewImage");
        img.src = imgData;
        img.style.display = "block";
        let dlLink = document.getElementById("downloadLink");
        dlLink.href = imgData;
        dlLink.download = "hoadon.png";
        dlLink.style.display = "block";
        alert("·∫¢nh ƒë√£ s·∫µn s√†ng! Tr√™n iPhone: nh·∫•n gi·ªØ ·∫£nh ƒë·ªÉ l∆∞u ho·∫∑c b·∫•m n√∫t t·∫£i.");
      });
    }

    document.getElementById("addProduct").addEventListener("click", ()=>addRow());
    document.getElementById("removeProduct").addEventListener("click", removeRow);
    document.getElementById("shipping").addEventListener("input", calculateTotal);
    document.getElementById("deposit").addEventListener("input", calculateTotal);

    function getFullDateText(date){
      const d = date.getDate();
      const m = date.getMonth() + 1;
      const y = date.getFullYear();
      return `Ng√†y ${d} th√°ng ${m} nƒÉm ${y}`;
    }
    document.getElementById("dateField").value = getFullDateText(new Date());

    addRow();
  </script>
</body>
</html>
