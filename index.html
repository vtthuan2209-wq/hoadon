<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>WebApp H√≥a ƒê∆°n</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#2a8bdc">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">

<style>
html, body {
  font-family:"Times New Roman", serif;
  background:#f0f0f0;
  margin:0;
  padding:10px;
}

#invoice {
  background:#fff;
  padding:10px;
  max-width:480px;
  margin:auto;
  border:1px solid #ccc;
  font-size:14px;
  box-sizing:border-box;
}

h1 {
  text-align:center;
  margin:8px 0;
  font-size:20px;
}

.info {
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-bottom:4px;
  font-size:13px;
}

.info label {
  font-weight:bold;
  flex:0 0 80px;
}

.info input {
  flex:1;
  font-size:16px; /* ‚â•16px ƒë·ªÉ iPhone kh√¥ng zoom */
  padding:2px 4px;
  height:24px;
  box-sizing:border-box;
}

table {
  width:100%;
  border-collapse:collapse;
  font-size:12px;
  table-layout:fixed;
  margin-top:6px;
}

th, td {
  border:1px solid #000;
  padding:2px 4px;
  text-align:center;
  line-height:1.2;
}

td input {
  width:100%;
  font-size:16px; /* ‚â•16px */
  padding:2px 4px;
  height:24px;
  box-sizing:border-box;
  text-align:right;
  border:1px solid #ccc;
}

#productTable th:nth-child(2), #productTable td:nth-child(2) { width:55%; }
#productTable th:nth-child(3), #productTable td:nth-child(3) { width:15%; }
#productTable th:nth-child(4), #productTable td:nth-child(4) { width:30%; }

.controls {
  margin-top:8px;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  justify-content:center;
}

.btn {
  flex:1;
  min-width:120px;
  padding:8px;
  border:none;
  border-radius:20px;
  background:#2a8bdc;
  color:#fff;
  font-size:14px;
  font-weight:bold;
  cursor:pointer;
  text-align:center;
}

.btn-danger {
  background:#e74c3c;
}

.footer {
  display:flex;
  justify-content:space-between;
  margin-top:8px;
  font-size:12px;
}

#previewImage {
  max-width:100%;
  display:none;
  border:1px solid #ccc;
  margin-top:6px;
}

#downloadLink {
  display:none;
  text-align:center;
  margin-top:6px;
  font-size:14px;
  color:blue;
}

.textlike {
  border:none;
  background:transparent;
  font-size:11px;
  text-align:right;
}

@media(max-width:480px){
  #invoice {padding:8px;}
  h1{font-size:18px;}
  .btn{min-width:100%; font-size:13px; padding:6px;}
}
</style>
</head>
<body>

<div id="invoice">
  <div style="display:flex; justify-content:space-between; margin-bottom:6px; align-items:flex-start;">
    <div style="flex:0 0 80px;">
      <img src="data:image/png;base64,..." alt="Logo" style="max-width:80px;">
    </div>
    <div style="flex:1; text-align:right; font-size:11px;">
      <div style="font-weight:bold; font-size:16px;">C√îNG TY TNHH G·ªñ M·ªòT T·∫§M</div>
      <div>Hotline: <input type="text" id="hotline" value="0568.638.638" class="textlike" style="width:70px;"></div>
      <div>X∆∞·ªüng: 138/3 APƒê03, P. An Ph√∫ ƒê√¥ng, Tp.HCM</div>
      <div>CH: 19 Hi·ªáp Th√†nh 43, P. T√¢n Th·ªõi Hi·ªáp, Tp.HCM</div>
    </div>
  </div>

  <h1>H√ìA ƒê∆†N</h1>

  <div class="info"><label>Kh√°ch h√†ng:</label> <input type="text" id="customer" placeholder="T√™n KH"></div>
  <div class="info"><label>SƒêT:</label> <input type="text" id="phone" placeholder="S·ªë ƒëi·ªán tho·∫°i"></div>
  <div class="info"><label>ƒêC:</label> <input type="text" id="address" placeholder="ƒê·ªãa ch·ªâ"></div>

  <div style="overflow-x:auto;">
    <table id="productTable">
      <thead>
        <tr>
          <th>STT</th>
          <th>T√™n S·∫£n Ph·∫©m</th>
          <th>SL</th>
          <th>Th√†nh ti·ªÅn</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <table style="margin-top:4px;">
    <tr><td colspan="3" style="text-align:right">V·∫≠n chuy·ªÉn:</td><td><input type="text" id="shipping" value="0"></td></tr>
    <tr><td colspan="3" style="text-align:right">T·ªîNG ƒê∆†N:</td><td><input type="text" id="totalOrder" value="0" readonly></td></tr>
    <tr><td colspan="3" style="text-align:right">C·ªåC TR∆Ø·ªöC:</td><td><input type="text" id="deposit" value="0"></td></tr>
    <tr><td colspan="3" style="text-align:right">GIAO H√ÄNG THANH TO√ÅN:</td><td><input type="text" id="finalPay" value="0" readonly></td></tr>
  </table>

  <div class="footer">
    <div class="date"><input type="text" id="dateField" class="textlike" style="text-align:left; width:180px;"></div>
    <div class="writer"><div>Ng∆∞·ªùi vi·∫øt h√≥a ƒë∆°n</div><input type="text" id="writerName" value="Thi√™n" class="textlike" style="width:100px; text-align:center;"></div>
  </div>

  <div style="margin-top:4px; font-size:12px;">
    <p><b>T√™n: ƒêinh Duy Lu√¢n</b><br>STK: 974666<br>Ng√¢n h√†ng √Å Ch√¢u (ACB)</p>
  </div>
</div>

<div class="controls">
  <button id="addProduct" class="btn">‚ûï Th√™m s·∫£n ph·∫©m</button>
  <button id="removeProduct" class="btn btn-danger">‚ùå X√≥a s·∫£n ph·∫©m</button>
</div>

<div class="controls">
  <button class="btn" onclick="saveInvoice()">üíæ L∆∞u t·∫°m</button>
  <button class="btn" onclick="exportImage()">üñº Xu·∫•t ·∫£nh</button>
  <button class="btn btn-danger" onclick="clearInvoice()">üóë X√≥a</button>
</div>

<img id="previewImage" alt="Preview h√≥a ƒë∆°n">
<a id="downloadLink">‚¨áÔ∏è T·∫£i ·∫£nh v·ªÅ m√°y</a>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
function formatNumber(value){return Number(value.toString().replace(/\D/g,"")||0).toLocaleString("vi-VN");}
function parseNumber(value){return parseInt(value.toString().replace(/\D/g,"")||0);}

function addRow(product="", qty=0, price=0){
  let tbody = document.querySelector("#productTable tbody");
  let rowCount = tbody.rows.length + 1;
  let row = document.createElement("tr");
  row.innerHTML = `
    <td>${rowCount}</td>
    <td><input type="text" value="${product}" placeholder="T√™n SP"></td>
    <td><input type="number" min="0" class="qty" value="${qty}" style="text-align:center"></td>
    <td><input type="text" class="price" value="${formatNumber(price)}"></td>
  `;
  tbody.appendChild(row);
  row.querySelector(".qty").addEventListener("input", calculateTotal);
  row.querySelector(".price").addEventListener("input", calculateTotal);
  calculateTotal();
}

function removeRow(){
  let tbody = document.querySelector("#productTable tbody");
  if(tbody.rows.length > 0){
    tbody.deleteRow(-1);
    renumberRows();
    calculateTotal();
  }
}

function renumberRows(){
  document.querySelectorAll("#productTable tbody tr").forEach((row,i)=>{
    row.cells[0].textContent = i+1;
  });
}

function calculateTotal(){
  let rows = document.querySelectorAll("#productTable tbody tr");
  let subtotal = 0;
  rows.forEach(row=>{
    let qty = parseNumber(row.querySelector(".qty").value)||0;
    let price = parseNumber(row.querySelector(".price").value)||0;
    subtotal += qty*price;
    row.querySelector(".price").value = formatNumber(price);
  });
  let shipping = parseNumber(document.getElementById("shipping").value)||0;
  let deposit = parseNumber(document.getElementById("deposit").value)||0;
  let totalOrder = subtotal + shipping;
  let finalPay = totalOrder - deposit;
  document.getElementById("shipping").value = formatNumber(shipping);
  document.getElementById("deposit").value = formatNumber(deposit);
  document.getElementById("totalOrder").value = formatNumber(totalOrder);
  document.getElementById("finalPay").value = formatNumber(finalPay);
}

function saveInvoice(){
  let data = {
    hotline: document.getElementById("hotline").value,
    customer: document.getElementById("customer").value,
    phone: document.getElementById("phone").value,
    address: document.getElementById("address").value,
    shipping: document.getElementById("shipping").value,
    deposit: document.getElementById("deposit").value,
    date: document.getElementById("dateField").value,
    writer: document.getElementById("writerName").value,
    products: []
  };
  document.querySelectorAll("#productTable tbody tr").forEach(row=>{
    data.products.push({
      product: row.cells[1].querySelector("input").value,
      qty: row.cells[2].querySelector("input").value,
      price: row.cells[3].querySelector("input").value
    });
  });
  localStorage.setItem("invoiceData", JSON.stringify(data));
  alert("ƒê√£ l∆∞u d·ªØ li·ªáu!");
}

function clearInvoice(){
  localStorage.removeItem("invoiceData");
  alert("ƒê√£ xo√° d·ªØ li·ªáu!");
  location.reload();
}

function exportImage(){
  html2canvas(document.querySelector("#invoice"), {scale:2}).then(canvas=>{
    let imgData = canvas.toDataURL("image/png");
    let img = document.getElementById("previewImage");
    img.src = imgData;
    img.style.display = "block";
    let dlLink = document.getElementById("downloadLink");
    dlLink.href = imgData;
    dlLink.download = "hoadon.png";
    dlLink.style.display = "block";
    alert("·∫¢nh ƒë√£ s·∫µn s√†ng! Tr√™n iPhone: nh·∫•n gi·ªØ ·∫£nh ƒë·ªÉ l∆∞u ho·∫∑c b·∫•m n√∫t t·∫£i.");
  });
}

document.getElementById("addProduct").addEventListener("click", ()=>addRow());
document.getElementById("removeProduct").addEventListener("click", removeRow);
document.getElementById("shipping").addEventListener("input", calculateTotal);
document.getElementById("deposit").addEventListener("input", calculateTotal);

function getFullDateText(date){
  const d = date.getDate();
  const m = date.getMonth() + 1;
  const y = date.getFullYear();
  return `Ng√†y ${d} th√°ng ${m} nƒÉm ${y}`;
}
document.getElementById("dateField").value = getFullDateText(new Date());
addRow();
</script>
</body>
</html>
